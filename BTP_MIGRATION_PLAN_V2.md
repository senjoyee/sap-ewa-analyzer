# SAP EWA Analyzer - BTP Migration Plan (V2)

**Status:** Draft / Planning  
**Previous Attempt:** Failed (Persistent 404s, Authorization Mismatches, Service Binding confusion)  
**Strategy Change:** Shift from manual `cf push` to **MTA (Multi-Target Application)** architecture.

---

## 1. Executive Summary & Learnings
The initial migration attempt failed primarily due to "drift" between the manual configuration of three separate components (AppRouter, UI Deployer, Backend) and their backing services (XSUAA, HTML5 Repo). 

**Key Learnings:**
*   **Manual Wiring is Fragile:** Manually binding services and setting `destinations` in `manifest.yml` led to mismatches.
*   **Authorization vs. Routing:** The persistent 404 was likely a "false 404" caused by the HTML5 Repo Runtime rejecting the token because the `sap.cloud.service` in the UI manifest did not match the XSUAA scopes exactly.
*   **Role Collections:** Manually creating Role Collections is error-prone. They should be defined as code.

**New Approach: The MTA Standard**
We will define the entire system in a single `mta.yaml`. This ensures:
1.  **Atomic Deployment:** All apps and services deploy together.
2.  **Automatic Binding:** Service keys and bindings are generated by BTP.
3.  **Consistent Naming:** Service instances are named deterministically.

---

## 2. Architecture: The "Golden Path"

The solution will consist of 3 modules and 4 resources.

### Modules (Applications)
1.  **`ewa-analyzer-backend`** (Python)
    *   **Runtime:** Python 3.11+
    *   **Role:** REST API, AI processing, Azure Blob interface.
    *   **Bindings:** XSUAA (for auth), Destination Service (if needed for outgoing calls).
2.  **`ewa-analyzer-ui-deployer`** (Node.js)
    *   **Runtime:** Node.js
    *   **Role:** One-time job to upload `sapui5/webapp` content to the HTML5 Repository.
    *   **Bindings:** HTML5 Repo Host.
3.  **`ewa-analyzer-approuter`** (Node.js)
    *   **Runtime:** Node.js
    *   **Role:** Entry point, Authentication, Reverse Proxy to Backend & HTML5 Repo.
    *   **Bindings:** XSUAA, HTML5 Repo Runtime, Destination Service.

### Resources (Services)
1.  **`ewaanalyzer-uaa`** (XSUAA)
    *   **Plan:** `application`
    *   **Config:** `xs-security.json` (defines Scopes, Roles, Attributes).
2.  **`ewaanalyzer-repo-host`** (HTML5 Application Repository Service)
    *   **Plan:** `app-host`
3.  **`ewaanalyzer-repo-runtime`** (HTML5 Application Repository Service)
    *   **Plan:** `app-runtime`
4.  **`ewaanalyzer-dest`** (Destination Service)
    *   **Plan:** `lite`

---

## 3. Detailed Implementation Plan

### Phase 1: MTA Configuration (`mta.yaml`)
*   **Task:** Create `mta.yaml` at project root.
*   **Critical Detail:** Define the `HTML5Runtime_enabled` property to `true` for the destination service.
*   **Risk:** If `xsappname` in `mta.yaml` doesn't match `xs-security.json`, deployment fails. 
    *   *Mitigation:* Use a placeholder `${xsappname}` in `xs-security.json` and let MTA replace it.

### Phase 2: Security Configuration (`xs-security.json`)
*   **Task:** Redefine `xs-security.json` to be simpler.
*   **Critical Detail:** Ensure the `oauth2-configuration` allows redirect URIs for the BTP domain (`https://*.hana.ondemand.com/**`).
*   **Risk (High):** The "Empty Roles" issue we saw previously.
    *   *Mitigation:* Do NOT use `attribute-references` in Role Templates unless we are mapping specific SAML attributes. For now, stick to `scope-references` only.

### Phase 3: Backend Preparation
*   **Task:** Ensure `ewa_main.py` detects BTP environment correctly.
*   **Code Change:** Verify `is_running_on_cf()` logic relies on `VCAP_SERVICES` or `VCAP_APPLICATION`.
*   **Risk:** Backend fails to start because it can't find Azure credentials.
    *   *Mitigation:* We must verify how Azure credentials are passed. 
        *   *Option A:* User-provided service (secure).
        *   *Option B:* Environment variables in `mta.yaml` (less secure but easier). *We will start with Option B for speed.*

### Phase 4: Frontend Preparation (The UI Deployer)
*   **Task:** Create a minimal `package.json` for the deployer.
*   **Structure:**
    ```text
    ui-deployer/
    ├── package.json (defines @sap/html5-app-deployer dependency)
    ├── resources/
    │   └── ewaanalyzer/ (COPY of sapui5/webapp goes here)
    ```
*   **Critical Detail (The 404 Fix):** The `manifest.json` in the UI app must have:
    ```json
    "sap.cloud": {
      "public": true,
      "service": "ewaanalyzer"
    }
    ```
    And the AppRouter route must match this service name.

### Phase 5: AppRouter Configuration
*   **Task:** Configure `xs-app.json`.
*   **Routing Logic:**
    *   `/api/` -> Forwards to `ewa-analyzer-backend` destination.
    *   `/` -> Forwards to `html5-apps-repo-rt` service.
*   **Critical Detail:** The backend destination must be created *by* the MTA during deployment, or created manually and referenced. MTA can create it using `parameters: content: instance: destinations: ...`.

---

## 4. Deployment Strategy

### Prerequisites
1.  **Cloud MTA Build Tool (MBT):** `npm install -g mbt`
2.  **CF CLI Plugin:** `cf install-plugin multiapps`

### Steps
1.  **Build:**
    ```bash
    mbt build -t ./mta_archives
    ```
    *This creates a `.mtar` file.*
2.  **Deploy:**
    ```bash
    cf deploy mta_archives/ewa_analyzer_1.0.0.mtar
    ```
    *This orchestrates the creation of all services and apps.*

---

## 5. Risk Assessment & Mitigations

| Risk | Probability | Impact | Mitigation |
| :--- | :--- | :--- | :--- |
| **404 Not Found (UI)** | High | Blocker | Use "Golden Path" config. Verify `sap.cloud.service` matches AppRouter route. Test accessing HTML5 Repo directly via `curl` if it fails. |
| **500 Internal Server Error (Backend)** | Medium | Blocker | Check `cf logs ewa-analyzer-backend --recent`. Ensure Azure creds are passed as ENV vars in `mta.yaml`. |
| **CORS Issues** | Medium | Annoyance | The AppRouter handles CORS. Ensure Backend has `CORSMiddleware` configured to allow `localhost` (dev) but relies on AppRouter for prod. |
| **Role Collection Missing** | Low | Access Denied | Define Role Collections in `mta.yaml` (`role-collections` section under `uaa` resource). |
| **Token Exchange Failures** | Medium | Auth Failure | Ensure `forwardAuthToken: true` is set in the destination config for the backend. |

---

## 6. Next Steps
1.  **Approval:** Confirm this MTA-based plan.
2.  **Scaffolding:** I will generate the `mta.yaml` and folder structure.
3.  **Migration:** We will move the artifacts into place and build.
